{"version":3,"file":"tarball.js","sources":["../node_modules/tarts/tarts.js","../src/types.ts","../src/utils.ts","../src/tarball.ts"],"sourcesContent":["export default tarts\n\nconst headers = {\n  name: 100,\n  mode: 8,\n  uid: 8,\n  gid: 8,\n  size: 12,\n  mtime: 12,\n  chksum: 8,\n  typeflag: 1,\n  linkname: 100,\n  magic: 5,\n  version: 2,\n  uname: 32,\n  gname: 32,\n  devmajor: 8,\n  devminor: 8,\n  prefix: 155,\n  padding: 12\n}\n\nconst offsets = {}\nObject.keys(headers).reduce((acc, k) => {\n  offsets[k] = acc\n  return acc + headers[k]\n}, 0)\n\nconst defaults = f => ({\n  name: f.name,\n  mode: '777',\n  uid: 0,\n  gid: 0,\n  size: f.content.byteLength,\n  mtime: Math.floor(Number(new Date()) / 1000),\n  chksum: '        ',\n  typeflag: '0',\n  magic: 'ustar',\n  version: '  ',\n  uname: '',\n  gname: ''\n})\n\nconst nopad = ['name', 'linkname', 'magic', 'chksum', 'typeflag', 'version', 'uname', 'gname']\n    , bsize = 512\n\nfunction tarts(files) {\n  return files.reduce((a, f) => {\n    if (typeof f.content === 'string')\n      f.content = stringToUint8(f.content)\n\n    f = Object.assign(defaults(f), f)\n\n    const b = new Uint8Array(Math.ceil((bsize + f.size) / bsize) * bsize)\n\n    const checksum = Object.keys(headers).reduce((acc, k) => {\n      if (!(k in f))\n        return acc\n\n      const value = stringToUint8(nopad.indexOf(k) > -1\n        ? f[k]\n        : pad(f[k], headers[k] - 1))\n\n      b.set(value, offsets[k])\n      return acc + value.reduce((a, b) => a + b, 0)\n    }, 0)\n\n    b.set(stringToUint8(pad(checksum, 7)), offsets.chksum)\n    b.set(f.content, bsize)\n\n    const sum = new Uint8Array(a.byteLength + b.byteLength)\n    sum.set(a, 0)\n    sum.set(b, a.byteLength)\n\n    return sum\n  }, new Uint8Array(0))\n}\n\nfunction pad(s, n) {\n  s = s.toString(8)\n  return ('000000000000' + s).slice(s.length + 12 - n)\n}\n\nfunction stringToUint8(s) {\n  const a = new Uint8Array(s.length)\n  for (let i = 0; i < s.length; i++)\n    a[i] = s.charCodeAt(i)\n  return a\n}\n","interface TargetFilter {\n  ADD_ITEMS: string;\n}\n\nexport type FilterKey = keyof TargetFilter;\n\nexport interface ItemType extends File {\n  // eslint-disable-next-line @typescript-eslint/naming-convention\n  _relativePath?: string;\n}\n\ntype FilterCallback = (items: ItemType[]) => Promise<ItemType[]>;\ntype AddFilterCallback = (key: FilterKey, callback: FilterCallback) => void;\n\nexport interface PluginOptions {\n  addFilter: AddFilterCallback;\n}\n\nexport interface Filter {\n  options: unknown;\n}\n\nexport interface Metadata {\n  percent: number;\n  currentFile: string;\n}\n\nexport type OnUpdateCallback = (metadata: Metadata) => void;\n\nexport type GeneratorCallback = (onUpdate?: OnUpdateCallback) => Promise<ItemType>;\n\nexport type TarballCallback = (generators: GeneratorCallback[]) => unknown;\n\nexport class Item extends File implements ItemType {\n  // eslint-disable-next-line @typescript-eslint/naming-convention\n  _relativePath?: string;\n}\n","// eslint-disable-next-line import/no-extraneous-dependencies\nimport Tar from 'tarts';\nimport {GeneratorCallback, Item, ItemType} from './types';\n\nconst directories = {};\n\nexport const getDirectoryGroups = (items: ItemType[]): Record<string, ItemType[]> => {\n  items\n    .filter((item) => item._relativePath)\n    .forEach((item) => {\n      const [, group] = item._relativePath.split('/');\n\n      if (!directories[group]) {\n        directories[group] = [];\n      }\n\n      directories[group].push(item);\n    });\n\n  return directories;\n};\n\nexport const generateTar = (items: ItemType[]): GeneratorCallback[] => {\n  getDirectoryGroups(items);\n\n  return Object.keys(directories).map((name) => {\n    const entries = [];\n\n    directories[name].forEach((file) => {\n      entries.push(\n        new Promise((resolve) => {\n          const reader = new FileReader();\n\n          reader.addEventListener('load', (event) => {\n            resolve({\n              name: file._relativePath,\n              content: event.target.result,\n            });\n          });\n          reader.readAsArrayBuffer(file);\n        })\n      );\n    });\n\n    // eslint-disable-next-line @typescript-eslint/no-dynamic-delete\n    delete directories[name];\n\n    return async (): Promise<ItemType> => {\n      const tar = Tar(await Promise.all(entries));\n      const file = new Blob([tar], {type: 'application/x-tar'});\n\n      return new Item([file], `${name}.tar`);\n    };\n  });\n};\n","import {Filter, PluginOptions, TarballCallback} from './types';\nimport {generateTar} from './utils';\n\nconst FilePondPluginTarball =\n  (callback?: TarballCallback) =>\n  ({addFilter}: PluginOptions): Filter => {\n    addFilter('ADD_ITEMS', async (items) => {\n      const generators = generateTar(items);\n      const plainFiles = items.filter((item) => !item._relativePath);\n\n      if (callback) {\n        callback(generators);\n\n        return plainFiles;\n      }\n\n      const tarFiles = await Promise.all(generators.map((generate) => generate()));\n\n      return plainFiles.concat(tarFiles);\n    });\n\n    return {options: {}};\n  };\n\nexport default FilePondPluginTarball;\n"],"names":["headers","name","mode","uid","gid","size","mtime","chksum","typeflag","linkname","magic","version","uname","gname","devmajor","devminor","prefix","padding","offsets","Object","keys","reduce","acc","k","nopad","pad","s","n","toString","slice","length","stringToUint8","a","Uint8Array","i","charCodeAt","Item","File","constructor","args","super","this","_relativePath","directories","callback","addFilter","items","generators","filter","item","forEach","group","split","push","getDirectoryGroups","map","entries","file","Promise","resolve","reader","FileReader","addEventListener","event","content","target","result","readAsArrayBuffer","all","then","_Promise$all","tar","f","assign","byteLength","Math","floor","Number","Date","defaults","b","ceil","checksum","value","indexOf","set","sum","Blob","type","e","reject","generateTar","plainFiles","generate","tarFiles","concat","options"],"mappings":"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"}